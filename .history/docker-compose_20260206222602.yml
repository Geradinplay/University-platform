version: '3.8'

services:
  db:
    image: postgres:13-alpine # Используем образ PostgreSQL версии 13
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER}       # Имя пользователя для PostgreSQL, берется из .env
      POSTGRES_PASSWORD: ${DB_PASSWORD} # Пароль пользователя, берется из .env
      POSTGRES_DB: ${DB_NAME}         # Имя базы данных, берется из .env
    ports:
      - "5432:5432" # Проксируем порт 5432 контейнера на порт 5432 вашей машины
    volumes:
      - db_data:/var/lib/postgresql/data # Сохраняем данные БД на хосте
      # Опционально: для автоматического запуска SQL-скрипта при первом запуске
      # - ./database_schema.sql:/docker-entrypoint-initdb.d/init.sql

  backend:
    build: . # Dockerfile для вашего Node.js бэкенда должен быть в корне проекта
    restart: always
    ports:
      - "3000:3000" # Проксируем порт 3000 контейнера на порт 3000 вашей машины (если ваш бэкенд слушает 3000)
    environment:
      DB_USER: ${DB_USER}
      DB_HOST: db # Имя сервиса 'db' в docker-compose используется как хост
      DB_NAME: ${DB_NAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_PORT: 5432
    depends_on:
      - db # Убедимся, что база данных запущена перед бэкендом
    # volumes:
    #   - ./backend_src:/app/src # Если ваш код бэкенда находится в подпапке
    #   - /app/node_modules # Чтобы не перезаписывать node_modules из контейнера

volumes:
  db_data: # Объявление тома для сохранения данных PostgreSQL
